<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Library “What’s On - Paraparaumu Library” Display</title>

  <!-- Tailwind + DaisyUI via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet"/>

  <!-- polyfills for older iOS -->
  <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,fetch,Promise,Array.prototype.includes"></script>
  <!-- babel standalone for ES6+ -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .card-body { overflow: hidden; max-height: 400px; }
    .card-title, .event-title { word-wrap: break-word; overflow-wrap: break-word; white-space: normal; }
  </style>
</head>
<body class="bg-gradient-to-r from-teal-400 via-teal-500 to-teal-600 text-white min-h-screen flex flex-col">

  <!-- Navbar -->
  <div class="navbar bg-transparent text-white mb-6 px-6">
    <div class="flex-1"><span class="text-3xl font-extrabold">Paraparaumu Library Schedule</span></div>
    <div><span id="current-date" class="text-lg"></span></div>
  </div>

  <div class="max-w-7xl mx-auto px-6 flex-1">
    <div id="rooms" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
  </div>

  <!-- Modal -->
  <input type="checkbox" id="event-modal" class="modal-toggle"/>
  <div class="modal"><div class="modal-box bg-white text-gray-800 relative">
    <label for="event-modal" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
    <h3 id="modal-summary" class="font-bold text-xl mb-2"></h3>
    <div id="modal-details" class="text-sm whitespace-pre-wrap"></div>
  </div></div>

  <script type="text/babel" data-presets="env">
    const API_KEY = 'AIzaSyD2qBhlb_rQHGh3kJ_ENFrxsRoFFmfrX8A';
    const calendars = [
      { id: 'paraparaumumake@gmail.com', name: 'Shared space' },
      { id: '99cb749e0421c837039bebfa2773ec2b696f4cbb5c8e1db0a27f071c38e871be@group.calendar.google.com', name: 'Makerspace' },
      { id: 'b952fc7ae8ea23d6f8648ee78ec4bbe830ecd5aa55266eb5a715bbcd3129718a@group.calendar.google.com', name: 'Discussion' },
      { id: '9d751487e4a33f27971ca1b54bd27d82b56d39278aabd6bcb562c431979396a2@group.calendar.google.com', name: 'Learning Centre' },
      { id: 'bf9774fd9a1f9cf44aff3d1ee97ef2a5e30789ef17f99ba846c3a780850f7e7a@group.calendar.google.com', name: 'Tamariki' },
      { id: '583fc72e7af8b504711782c092a5e3c8ea73eda4d2e4d87128c0e78d471be68c@group.calendar.google.com', name: 'Tech Lab' }
    ];

    document.getElementById('current-date').textContent =
      new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    const formatTime = ds => new Date(ds).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    const formatDateTime = ds => new Date(ds).toLocaleString([], {weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});

    async function fetchEvents(calendarId, timeMin, timeMax) {
      const res = await fetch(
        `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${API_KEY}` +
        `&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`
      );
      return (await res.json()).items || [];
    }

    async function init() {
      const container = document.getElementById('rooms');
      const now = new Date();
      const todayMin = new Date(now.setHours(0,0,0,0)).toISOString();
      const todayMax = new Date(now.setHours(23,59,59,999)).toISOString();

      // Daily cards
      for (const cal of calendars) {
        const card = document.createElement('div');
        card.className = 'card bg-white shadow-xl border-2 border-teal-300 rounded-lg hover:shadow-2xl';
        container.appendChild(card);
        const body = document.createElement('div'); body.className = 'card-body p-6'; card.appendChild(body);
        body.innerHTML = `<h2 class="card-title mb-2 text-black">${cal.name} <span class="badge badge-info"></span></h2><div class="divider"></div>`;
        const badge = body.querySelector('.badge-info');

        const events = await fetchEvents(cal.id, todayMin, todayMax);
        badge.textContent = `${events.length} ${events.length===1?'event':'events'}`;

        if (!events.length) {
          const p = document.createElement('p'); p.className = 'text-gray-500 text-center py-4'; p.textContent = 'No events today'; body.appendChild(p);
        } else {
          const table = document.createElement('table'); table.className = 'table w-full';
          table.innerHTML = `<thead><tr><th>Event</th><th>Time</th></tr></thead><tbody></tbody>`;
          events.forEach(e => {
            const row = document.createElement('tr'); row.className='hover:bg-teal-50 cursor-pointer';
            const start= formatTime(e.start.dateTime||e.start.date), end= formatTime(e.end.dateTime||e.end.date);
            row.innerHTML = `<td class="event-title text-sm text-black">${e.summary}</td><td class="text-sm font-semibold text-black">${start} - ${end}</td>`;
            row.addEventListener('click', ()=> showModal(e.summary, [{start,end,location:e.location,desc:e.description}]));
            table.querySelector('tbody').appendChild(row);
          });
          body.appendChild(table);
        }
      }

      // Weekly grouped card
      const cardAll = document.createElement('div');
      cardAll.className = 'card bg-white shadow-xl border-2 border-teal-300 rounded-lg hover:shadow-2xl';
      container.appendChild(cardAll);
      const bodyAll = document.createElement('div'); bodyAll.className='card-body p-6'; cardAll.appendChild(bodyAll);
      bodyAll.innerHTML = `<h2 class="card-title text-xl font-bold mb-4 text-black">All Events This Week</h2><div class="divider"></div>`;

      // week range
      const startW = new Date(); startW.setDate(startW.getDate() - now.getDay()); startW.setHours(0,0,0,0);
      const endW = new Date(startW); endW.setDate(startW.getDate()+6); endW.setHours(23,59,59,999);
      const evs = [];
      for (const cal of calendars) evs.push(...await fetchEvents(cal.id, startW.toISOString(), endW.toISOString()));

      const grouped = evs.reduce((a,e)=>{ const t=e.summary||'No title'; (a[t]=a[t]||[]).push(e); return a; },{});
      if (!Object.keys(grouped).length) {
        const p=document.createElement('p'); p.className='text-gray-500 text-center py-4'; p.textContent='No events this week'; bodyAll.appendChild(p);
      } else {
        const ul=document.createElement('ul'); ul.className='space-y-2';
        Object.entries(grouped).forEach(([title,list])=>{
          const first=list[0];
          const li=document.createElement('li'); li.className='flex justify-between text-sm text-black cursor-pointer hover:bg-teal-50 p-2 rounded';
          li.innerHTML = `<span>${title} <span class="font-semibold">(${list.length})</span></span><span class="font-semibold">${formatDateTime(first.start.dateTime||first.start.date)}</span>`;
          li.addEventListener('click', ()=>{
            const details=list.map(ev=>{
              const s=formatDateTime(ev.start.dateTime||ev.start.date); const e=formatTime(ev.end.dateTime||ev.end.date); const loc=ev.location||'No location';
              return `<div class=\"mb-2\"><strong>${s}</strong> - ${e}, ${loc}</div>`;
            });
            showModal(title, details);
          });
          ul.appendChild(li);
        }); bodyAll.appendChild(ul);
      }
    }

    function showModal(title, items) {
      document.getElementById('modal-summary').textContent = title;
      document.getElementById('modal-details').innerHTML = items.map(i=> typeof i==='string'?i:`<div>${i.start} - ${i.end}, ${i.location}<p>${i.desc||''}</p></div>`).join('');
      document.getElementById('event-modal').checked = true;
    }

    init();
  </script>
</body>
</html>

