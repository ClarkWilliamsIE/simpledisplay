<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Library “What’s On - Paraparaumu Library” Display</title>

  <!-- Tailwind + DaisyUI via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet"/>

  <!-- polyfills for iOS 9/10 -->
  <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,fetch,Promise,Array.prototype.includes"></script>
  <!-- babel standalone for transpiling ES6+ to ES5 -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .card-body { overflow: hidden; max-height: 400px }
    .card-title { word-wrap: break-word; overflow-wrap: break-word; white-space: normal }
    .event-title { word-wrap: break-word; overflow-wrap: break-word; white-space: normal }
  </style>
</head>
<body class="bg-gradient-to-r from-teal-400 via-teal-500 to-teal-600 text-white min-h-screen flex flex-col">

  <!-- Navbar with current date -->
  <div class="navbar bg-transparent text-white mb-6">
    <div class="flex-1 px-6">
      <span class="text-3xl font-extrabold">Paraparaumu Library Schedule</span>
    </div>
    <div class="px-6">
      <span id="current-date" class="text-lg"></span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-6 flex-1">
    <div id="rooms" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
  </div>

  <!-- Modal for event details -->
  <input type="checkbox" id="event-modal" class="modal-toggle"/>
  <div class="modal">
    <div class="modal-box bg-white text-gray-800 relative">
      <label for="event-modal" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
      <h3 id="modal-summary" class="font-bold text-xl mb-2"></h3>
      <p id="modal-time" class="mb-2"></p>
      <p id="modal-location" class="mb-2"></p>
      <div id="modal-description" class="whitespace-pre-wrap text-sm"></div>
    </div>
  </div>

  <!-- Script with polyfills and transpilation -->
  <script type="text/babel" data-presets="env">
    const API_KEY = 'YOUR_API_KEY';
    const calendars = [ /* your calendar list */ ];

    document.getElementById('current-date').textContent =
      new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    const formatTime = ds => new Date(ds).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const formatDate = ds => new Date(ds).toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });

    async function fetchEventsForThisWeek() {
      const allEvents = [];
      const now = new Date();
      const start = new Date(now);
      start.setDate(now.getDate() - now.getDay()); start.setHours(0,0,0,0);
      const end = new Date(start);
      end.setDate(start.getDate() + 6); end.setHours(23,59,59,999);
      const timeMin = start.toISOString();
      const timeMax = end.toISOString();

      for (const cal of calendars) {
        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(cal.id)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
        const res = await fetch(url);
        const items = (await res.json()).items || [];
        allEvents.push(...items);
      }
      return allEvents;
    }

    async function init() {
      const container = document.getElementById('rooms');

      // ... render individual day cards as before ...

      // All Events This Week (grouped by summary)
      const allCard = document.createElement('div');
      allCard.className = 'card bg-white shadow-xl border-2 border-teal-300 rounded-lg';
      container.appendChild(allCard);
      const allBody = document.createElement('div'); allBody.className = 'card-body p-6';
      allCard.appendChild(allBody);
      allBody.innerHTML = `<h2 class="card-title text-xl font-bold mb-4 text-black">All Events This Week</h2><div class="divider"></div>`;

      const events = await fetchEventsForThisWeek();
      if (!events.length) {
        const p = document.createElement('p'); p.className = 'text-gray-500 text-center py-4';
        p.textContent = 'No events this week'; allBody.appendChild(p);
      } else {
        // Group by summary
        const grouped = events.reduce((acc,e) => {
          const key = e.summary || 'No title';
          if (!acc[key]) acc[key] = [];
          acc[key].push(e);
          return acc;
        }, {});

        const ul = document.createElement('ul'); ul.className = 'space-y-2';

        Object.entries(grouped).forEach(([summary, list]) => {
          // sort occurrences by start
          list.sort((a,b) => new Date(a.start.dateTime||a.start.date) - new Date(b.start.dateTime||b.start.date));
          const first = list[0];
          const startLabel = `${formatDate(first.start.dateTime||first.start.date)} ${formatTime(first.start.dateTime||first.start.date)}`;

          const li = document.createElement('li');
          li.className = 'flex justify-between text-sm text-black cursor-pointer hover:bg-teal-50 p-2 rounded';
          li.innerHTML = `<span>${summary}</span><span class="font-semibold">${startLabel}</span>`;

          li.addEventListener('click', () => {
            document.getElementById('modal-summary').textContent = summary;
            document.getElementById('modal-time').textContent = '';
            document.getElementById('modal-location').textContent = '';
            // build occurrences list
            const details = list.map(e => {
              const date = formatDate(e.start.dateTime||e.start.date);
              const time = `${formatTime(e.start.dateTime||e.start.date)} - ${formatTime(e.end.dateTime||e.end.date)}`;
              return `<li>${date}, ${time}${e.location?`, @ ${e.location}`: ''}</li>`;
            }).join('');
            document.getElementById('modal-description').innerHTML = `<ul>${details}</ul>`;
            document.getElementById('event-modal').checked = true;
          });
          ul.appendChild(li);
        });
        allBody.appendChild(ul);
      }
    }

    init();
  </script>
</body>
</html>
