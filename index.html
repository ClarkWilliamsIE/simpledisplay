<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Library "What’s On - Paraparaumu Library" Display</title>

  <!-- Tailwind + DaisyUI via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet"/>

  <style>
    .card-body {
      max-height: 400px; /* keep height consistent */
      overflow: hidden;  /* hide vertical overflow on daily cards */
    }

    .all-events-body {
      max-height: 600px; /* taller for week view */
      overflow-y: auto;  /* vertical scroll for week list */
    }

    .card-title,
    .event-title,
    th, td {
      word-wrap: break-word;    /* break long words */
      overflow-wrap: break-word;
      white-space: normal;      /* allow wrapping */
    }
  </style>
</head>
<body class="bg-gradient-to-r from-teal-400 via-teal-500 to-teal-600 text-white min-h-screen flex flex-col">

  <!-- Navbar with current date -->
  <div class="navbar bg-transparent text-white mb-6">
    <div class="flex-1 px-6">
      <span class="text-3xl font-extrabold">Paraparaumu Library Schedule</span>
    </div>
    <div class="px-6">
      <span id="current-date" class="text-lg"></span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-6 flex-1">
    <div id="rooms" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
  </div>

  <!-- Modal for event details -->
  <input type="checkbox" id="event-modal" class="modal-toggle"/>
  <div class="modal">
    <div class="modal-box bg-white text-gray-800 relative">
      <label for="event-modal" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
      <h3 id="modal-summary" class="font-bold text-xl mb-2"></h3>
      <p id="modal-time" class="mb-2"></p>
      <p id="modal-location" class="mb-2"></p>
      <div id="modal-description" class="whitespace-pre-wrap text-sm"></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const API_KEY = 'AIzaSyD2qBhlb_rQHGh3kJ_ENFrxsRoFFmfrX8A';
    const calendars = [
      { id: 'paraparaumumake@gmail.com', name: 'Shared space' },
      { id: '99cb749e0421c837039bebfa2773ec2b696f4cbb5c8e1db0a27f071c38e871be@group.calendar.google.com', name: 'Makerspace' },
      { id: 'b952fc7ae8ea23d6f8648ee78ec4bbe830ecd5aa55266eb5a715bbcd3129718a@group.calendar.google.com', name: 'Discussion' },
      { id: '9d751487e4a33f27971ca1b54bd27d82b56d39278aabd6bcb562c431979396a2@group.calendar.google.com', name: 'Learning Centre' },
      { id: 'bf9774fd9a1f9cf44aff3d1ee97ef2a5e30789ef17f99ba846c3a780850f7e7a@group.calendar.google.com', name: 'Tamariki' },
      { id: '583fc72e7af8b504711782c092a5e3c8ea73eda4d2e4d87128c0e78d471be68c@group.calendar.google.com', name: 'Tech Lab' },
    ];

    // === HEADER DATE ===
    document.getElementById('current-date').textContent =
      new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // === HELPERS ===
    const formatDateTime = iso => {
      const d = new Date(iso);
      const day = d.toLocaleString('en-GB', { weekday: 'long' });
      const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      return `${day}, ${time}`;
    };

    async function fetchEvents(id, timeMin, timeMax) {
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(id)}/events`
                + `?key=${API_KEY}`
                + `&timeMin=${timeMin}&timeMax=${timeMax}`
                + `&singleEvents=true&orderBy=startTime`;
      const res = await fetch(url);
      return (await res.json()).items || [];
    }

    async function fetchEventsForToday(id) {
      const now = new Date();
      const timeMin = new Date(now.setHours(0, 0, 0, 0)).toISOString();
      const timeMax = new Date(now.setHours(23, 59, 59, 999)).toISOString();
      return fetchEvents(id, timeMin, timeMax);
    }

    async function fetchEventsForWeek() {
      const now = new Date();
      const start = new Date(now);
      start.setDate(now.getDate() - now.getDay());
      start.setHours(0,0,0,0);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      end.setHours(23,59,59,999);
      const timeMin = start.toISOString();
      const timeMax = end.toISOString();

      let all = [];
      for (const cal of calendars) {
        const items = await fetchEvents(cal.id, timeMin, timeMax);
        all = all.concat(items);
      }
      return all;
    }

    // === RENDER ===
    async function init() {
      const container = document.getElementById('rooms');
      let weekEvents = [];

      // daily cards
      for (const cal of calendars) {
        const card = document.createElement('div');
        card.className = 'card bg-white shadow-xl border-2 border-teal-300 rounded-lg hover:shadow-2xl transition-all duration-300 ease-in-out';
        container.appendChild(card);

        const body = document.createElement('div');
        body.className = 'card-body p-6';
        card.appendChild(body);

        const events = await fetchEventsForToday(cal.id);
        weekEvents = weekEvents.concat(events);

        body.innerHTML = `
          <h2 class="card-title mb-2 text-black">
            ${cal.name}
            <span class="badge badge-info">${events.length} ${events.length === 1 ? 'event' : 'events'}</span>
          </h2>
          <div class="divider"></div>
        `;

        if (!events.length) {
          const p = document.createElement('p');
          p.className = 'text-gray-500 text-center py-4';
          p.textContent = 'No events today';
          body.appendChild(p);
        } else {
          const wrapper = document.createElement('div');
          wrapper.className = 'overflow-x-auto';
          wrapper.innerHTML = `
            <table class="table table-fixed w-full">
              <thead>
                <tr>
                  <th class="text-sm font-semibold text-black break-words">Event</th>
                  <th class="text-sm font-semibold text-black break-words">Time</th>
                </tr>
              </thead>
              <tbody>
                ${events.map(e => {
                  const start = formatDateTime(e.start.dateTime || e.start.date);
                  const end = formatDateTime(e.end.dateTime || e.end.date);
                  return `
                    <tr class="hover:bg-teal-50 cursor-pointer">
                      <td class="text-sm text-black break-words">${e.summary || ''}</td>
                      <td class="text-sm font-semibold text-black break-words">${start} - ${end}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
          // attach click listeners
          wrapper.querySelectorAll('tr.hover\\:bg-teal-50').forEach((row, i) => {
            const e = events[i];
            const start = formatDateTime(e.start.dateTime || e.start.date);
            const end = formatDateTime(e.end.dateTime || e.end.date);
            row.addEventListener('click', () => {
              document.getElementById('modal-summary').textContent   = e.summary || 'No title';
              document.getElementById('modal-time').textContent      = `${start} - ${end}`;
              document.getElementById('modal-location').textContent  = e.location || 'No location specified';
              document.getElementById('modal-description').innerHTML = e.description || '<p>No description provided</p>';
              document.getElementById('event-modal').checked = true;
            });
          });
          body.appendChild(wrapper);
        }
      }

      // week card
      const weekCard = document.createElement('div');
      weekCard.className = 'card bg-white shadow-xl border-2 border-teal-300 rounded-lg hover:shadow-2xl transition-all duration-300 ease-in-out';
      container.appendChild(weekCard);

      const weekBody = document.createElement('div');
      weekBody.className = 'card-body p-6 all-events-body';
      weekCard.appendChild(weekBody);

      weekBody.innerHTML = `
        <h2 class="card-title text-xl font-bold mb-4 text-black">All Events This Week</h2>
        <div class="divider"></div>
      `;

      if (!weekEvents.length) {
        const p = document.createElement('p');
        p.className = 'text-gray-500 text-center py-4';
        p.textContent = 'No events this week';
        weekBody.appendChild(p);
      } else {
        const map = {};
        weekEvents.forEach(e => {
          const title = e.summary || '';
          const start = formatDateTime(e.start.dateTime || e.start.date);
          if (!map[title]) map[title] = [];
          map[title].push({ start, e });
        });

        Object.entries(map).forEach(([title, occ]) => {
          const li = document.createElement('li');
          li.className = 'text-sm text-black cursor-pointer hover:bg-teal-50 p-2 rounded break-words';
          li.innerHTML = `<span class="font-bold">${title}</span>`;
          li.addEventListener('click', () => {
            document.getElementById('modal-summary').innerHTML = `${title}`;
            document.getElementById('modal-time').innerHTML = occ.map(o => `<div><strong>When:</strong> ${o.start}</div>`).join('');
            document.getElementById('modal-location').textContent = occ[0].e.location || 'No location specified';
            document.getElementById('modal-description').innerHTML = occ[0].e.description || '<p>No description provided</p>';
            document.getElementById('event-modal').checked = true;
          });
          weekBody.appendChild(li);
        });
      }
    }

    init();
  </script>
</body>
</html>
