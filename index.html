<script>
  const API_KEY = 'AIzaSyD2qBhlb_rQHGh3kJ_ENFrxsRoFFmfrX8A'; // Your key

  const roomColors = {
    'paraparaumumake@gmail.com': 'bg-blue-600',
    '99cb749e0421c837039bebfa2773ec2b696f4cbb5c8e1db0a27f071c38e871be@group.calendar.google.com': 'bg-green-600',
    'b952fc7ae8ea23d6f8648ee78ec4bbe830ecd5aa55266eb5a715bbcd3129718a@group.calendar.google.com': 'bg-yellow-600',
    '9d751487e4a33f27971ca1b54bd27d82b56d39278aabd6bcb562c431979396a2@group.calendar.google.com': 'bg-pink-600',
    'bf9774fd9a1f9cf44aff3d1ee97ef2a5e30789ef17f99ba846c3a780850f7e7a@group.calendar.google.com': 'bg-indigo-600',
    '583fc72e7af8b504711782c092a5e3c8ea73eda4d2e4d87128c0e78d471be68c@group.calendar.google.com': 'bg-purple-600',
    'b0228e246833cd5cafecfbbdda140afec688229319ee1a9643d5043abc0f2d46@group.calendar.google.com': 'bg-red-600',
  };

  const calendars = [
    { id: 'paraparaumumake@gmail.com', name: 'Flexi space' },
    { id: '9d751487e4a33f27971ca1b54bd27d82b56d39278aabd6bcb562c431979396a2@group.calendar.google.com', name: 'Upstairs learning centre' },
    { id: '99cb749e0421c837039bebfa2773ec2b696f4cbb5c8e1db0a27f071c38e871be@group.calendar.google.com', name: 'Makerspace' },
    { id: 'b952fc7ae8ea23d6f8648ee78ec4bbe830ecd5aa55266eb5a715bbcd3129718a@group.calendar.google.com', name: 'Ground floor lounge' },
    { id: 'bf9774fd9a1f9cf44aff3d1ee97ef2a5e30789ef17f99ba846c3a780850f7e7a@group.calendar.google.com', name: 'Tamariki space' },
    { id: '583fc72e7af8b504711782c092a5e3c8ea73eda4d2e4d87128c0e78d471be68c@group.calendar.google.com', name: 'Upstairs lounge' },
    { id: 'b0228e246833cd5cafecfbbdda140afec688229319ee1a9643d5043abc0f2d46@group.calendar.google.com', name: 'Justice of the Peace' },
  ];

  // Set current date in header
  document.getElementById('current-date').textContent = new Date().toLocaleDateString([], {
    weekday: 'long', month: 'long', day: 'numeric',
  });

  // Helper function to format time
  function formatTime(dateStr) {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }

  // Helper function to fetch events
  async function fetchEvents(calId, timeMin, timeMax) {
    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events`
      + `?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
    try {
      const res = await fetch(url);
      if (!res.ok) {
        console.error(`Error fetching calendar ${calId}: ${res.statusText}`);
        return [];
      }
      return (await res.json()).items || [];
    } catch (error) {
      console.error(`Network error for ${calId}:`, error);
      return [];
    }
  }

  // Main function to build the dashboard
  async function loadDashboard() {
    const now = new Date();
    
    // --- Date ranges ---
    const todayStart = new Date(now);
    todayStart.setHours(0, 0, 0, 0);
    const todayEnd = new Date(now);
    todayEnd.setHours(23, 59, 59, 999);
    
    const weekStart = new Date(todayStart);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6); // 6 days from today = 7 days total
    weekEnd.setHours(23, 59, 59, 999);

    const todayStartStr = todayStart.toISOString();
    const todayEndStr = todayEnd.toISOString();
    const weekStartStr = weekStart.toISOString();
    const weekEndStr = weekEnd.toISOString();

    // --- Get containers ---
    const roomContainer = document.getElementById('room-events');
    const weeklyGrid = document.getElementById('weekly-grid');
    
    // --- **FIX PART 1**: Set loading message with a specific ID ---
    roomContainer.innerHTML = '<p id="room-loading-msg" class="text-2xl text-gray-400">Loading room status...</p>';
    weeklyGrid.innerHTML = ''; // Clear weekly grid
    
    // This will hold all events for the 7-day grid
    const eventsByDay = Array.from({ length: 7 }, () => []);

    // --- Process each calendar ---
    for (const cal of calendars) {
      // Fetch BOTH today's events (for "Now/Next") and the week's events (for the grid)
      const todayEvents = await fetchEvents(cal.id, todayStartStr, todayEndStr);
      const weekEvents = await fetchEvents(cal.id, weekStartStr, weekEndStr);
      const roomColor = roomColors[cal.id] || 'bg-gray-600';

      // 1. Populate the weekly grid data
      for (const e of weekEvents) {
        const date = new Date(e.start.dateTime || e.start.date);
        // Calculate day index (0 = today, 1 = tomorrow, etc.)
        const index = Math.floor((date.getTime() - todayStart.getTime()) / (1000 * 60 * 60 * 24));
        if (index >= 0 && index < 7) {
          eventsByDay[index].push({ ...e, calId: cal.id, roomName: cal.name });
        }
      }

      // 2. Create the "Room Status" card for today
      const card = document.createElement('div');
      card.className = `highlight-card p-6 rounded-xl shadow-lg flex flex-col`;
      
      const bgColorClass = roomColors[cal.id] || 'bg-gray-600';
      const colorMap = {
        'bg-blue-600': '#2563eb',
        'bg-green-600': '#16a34a',
        'bg-yellow-600': '#ca8a04',
        'bg-pink-600': '#db2777',
        'bg-indigo-600': '#4f46e5',
        'bg-purple-600': '#9333ea',
        'bg-red-600': '#dc2626',
        'bg-gray-600': '#4b5563'
      };
      card.style.borderTop = `5px solid ${colorMap[bgColorClass] || '#4b5563'}`;


      let cardContent = '';
      
      // Find the current and next event
      const nowTime = now.getTime();
      const currentEvent = todayEvents.find(e => {
        const start = new Date(e.start.dateTime || e.start.date).getTime();
        const end = new Date(e.end.dateTime || e.end.date).getTime();
        // Handle all-day events
        if (!e.start.dateTime) { 
          const allDayStart = new Date(e.start.date).setHours(0,0,0,0);
          const allDayEnd = new Date(e.end.date).setDate(new Date(e.end.date).getDate() - 1);
          allDayEnd.setHours(23,59,59,999);
          return allDayStart <= nowTime && allDayEnd > nowTime;
        }
        return start <= nowTime && end > nowTime;
      });
      
      const nextEvent = todayEvents.find(e => 
        new Date(e.start.dateTime || e.start.date).getTime() > nowTime
      );

      if (currentEvent) {
        // --- Room is IN USE ---
        const endTime = currentEvent.end.dateTime ? 
          `Until ${formatTime(currentEvent.end.dateTime)}` : 'All Day';
        cardContent = `
          <div class="mb-4">
            <span class="status-label">Now</span>
            <p class="status-event status-now">${currentEvent.summary}</p>
            <p class="status-time">${endTime}</p>
          </div>
          ${nextEvent ? `
            <div>
              <span class="status-label">Next</span>
              <p class="status-event">${nextEvent.summary}</p>
              <p class="status-time">At ${formatTime(nextEvent.start.dateTime || nextEvent.start.date)}</p>
            </div>
          ` : `
            <div>
              <span class="status-label">Next</span>
              <p class="status-event text-gray-400">No more events today</p>
            </div>
          `}
        `;
      } else if (nextEvent) {
        // --- Room is AVAILABLE ---
        cardContent = `
          <div class="mb-4">
            <p class="status-available">Available</p>
          </div>
          <div>
            <span class="status-label">Next</span>
            <p class="status-event">${nextEvent.summary}</p>
            <p class="status-time">At ${formatTime(nextEvent.start.dateTime || nextEvent.start.date)}</p>
          </div>
        `;
      } else {
        // --- Room is FREE all day ---
        cardContent = `
          <div>
            <p class="status-available">Available</p>
            <p class="status-event text-gray-400 mt-2">No events scheduled today</p>
          </div>
        `;
      }

      card.innerHTML = `
        <h3 class="card-title mb-4 text-white">${cal.name}</h3>
        <div classs="space-y-4">
          ${cardContent}
        </div>
      `;
      // This appends the card *after* the "Loading..." P tag
      roomContainer.appendChild(card);
    }
    
    // --- **FIX PART 2**: Remove only the loading message by its ID ---
    // This runs *after* the loop, so all cards are already in the DOM.
    const roomLoading = document.getElementById('room-loading-msg');
    if (roomLoading) {
      roomLoading.remove();
    }


    // --- 3. Build the 7-Day Weekly Grid ---
    for (let i = 0; i < 7; i++) {
      const dayDate = new Date(weekStart);
      dayDate.setDate(weekStart.getDate() + i);
      const label = dayDate.toLocaleDateString([], { weekday: 'short' });
      const dateNum = dayDate.toLocaleDateString([], { day: 'numeric', month: 'short' });

      const col = document.createElement('div');
      col.className = 'highlight-card p-4 rounded-lg text-gray-100';
      // Bigger, clearer header for the day
      col.innerHTML = `
        <h4 class="text-2xl font-bold text-center text-white">${label}</h4>
        <p class="text-base text-gray-400 text-center mb-4">${dateNum}</p>
      `;

      const dayEvents = eventsByDay[i];
      // Sort events by start time
      dayEvents.sort((a, b) => new Date(a.start.dateTime || a.start.date) - newS Date(b.start.dateTime || b.start.date));

      if (dayEvents.length === 0) {
        col.innerHTML += `<p class="text-base text-center text-gray-500">No events</p>`;
      } else {
        const list = document.createElement('ul');
        list.className = 'space-y-3'; // More spacing
        for (const e of dayEvents) {
          const start = e.start.dateTime ? formatTime(e.start.dateTime) : 'All Day';
          const colorClass = roomColors[e.calId] || 'bg-gray-700';
          const li = document.createElement('li');
          // Bigger text, better layout
          li.innerHTML = `
            <div class="text-lg font-medium text-white">${e.summary}</div>
            <div class="flex justify-between items-center text-base mt-1">
              <span class="text-gray-300 truncate pr-2" title="${e.roomName}">${e.roomName}</span>
              <span class="rounded px-2 py-0.5 ${colorClass} text-white font-medium flex-shrink-0">${start}</span>
            </div>`;
          list.appendChild(li);
        }
        col.appendChild(list);
      }
      weeklyGrid.appendChild(col);
    }
  }

  // --- Load and refresh ---
  loadDashboard();
  setInterval(loadDashboard, 5 * 60 * 1000); // Refresh every 5 minutes for more up-to-date status

  // --- Fullscreen toggle logic (unchanged) ---
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  function checkFullscreen() {
    const isFullscreen = document.fullscreenElement != null;
    fullscreenBtn.classList.toggle('hidden', isFullscreen);
  }
  fullscreenBtn.addEventListener('click', () => {
    const el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.msRequestFullscreen) el.msRequestFullscreen();
  });
  document.addEventListener('fullscreenchange', checkFullscreen);
  document.addEventListener('webkitfullscreenchange', checkFullscreen);
  document.addEventListener('msfullscreenchange', checkFullscreen);
  checkFullscreen();
</script>
